openapi: 3.0.0
info:
  title: Narfe API
  description: Premium travel platform API combining TikTok-style feeds with Airbnb-like discovery
  version: 1.0.0
  contact:
    name: Narfe Support
    url: https://narfe.world
    email: support@narfe.world

servers:
  - url: https://{project-id}.supabase.co
    description: Supabase Production
    variables:
      project-id:
        default: your-project-id
        description: Your Supabase project ID

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Profile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        username:
          type: string
        full_name:
          type: string
        avatar_url:
          type: string
        bio:
          type: string
        role:
          type: string
          enum: [user, creator, founding_creator, admin]
        followers_count:
          type: integer
        following_count:
          type: integer
        itineraries_count:
          type: integer

    Itinerary:
      type: object
      required:
        - title
        - location
        - creator_id
      properties:
        id:
          type: string
          format: uuid
        creator_id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 200
        description:
          type: string
        location:
          type: string
        country:
          type: string
        city:
          type: string
        duration:
          type: string
        category:
          type: string
        tags:
          type: array
          items:
            type: string
        price:
          type: number
          format: decimal
          minimum: 0
        currency:
          type: string
          default: EUR
        cover_image_url:
          type: string
        video_url:
          type: string
        likes_count:
          type: integer
        saves_count:
          type: integer
        views_count:
          type: integer
        status:
          type: string
          enum: [draft, published, archived]
        published_at:
          type: string
          format: date-time

    ItineraryStop:
      type: object
      required:
        - itinerary_id
        - day_number
        - stop_order
        - title
      properties:
        id:
          type: string
          format: uuid
        itinerary_id:
          type: string
          format: uuid
        day_number:
          type: integer
          minimum: 1
        stop_order:
          type: integer
          minimum: 1
        title:
          type: string
        description:
          type: string
        latitude:
          type: number
          format: decimal
        longitude:
          type: number
          format: decimal
        address:
          type: string
        place_name:
          type: string

    Purchase:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        itinerary_id:
          type: string
          format: uuid
        amount:
          type: number
          format: decimal
        currency:
          type: string
        status:
          type: string
          enum: [pending, completed, failed, refunded]
        purchased_at:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string
        details:
          type: string
        code:
          type: string

paths:
  /functions/v1/createPurchase:
    post:
      summary: Create a purchase
      description: Process payment and create purchase record via Stripe Connect
      operationId: createPurchase
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - itineraryId
                - paymentMethodId
              properties:
                itineraryId:
                  type: string
                  format: uuid
                paymentMethodId:
                  type: string
                  description: Stripe payment method ID
      responses:
        '200':
          description: Purchase created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  purchase:
                    $ref: '#/components/schemas/Purchase'
                  paymentIntent:
                    type: object
                    properties:
                      id:
                        type: string
                      status:
                        type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '404':
          description: Itinerary not found

  /functions/v1/createItinerary:
    post:
      summary: Create an itinerary
      description: Create a new travel itinerary with stops
      operationId: createItinerary
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - location
              properties:
                title:
                  type: string
                description:
                  type: string
                location:
                  type: string
                country:
                  type: string
                city:
                  type: string
                duration:
                  type: string
                category:
                  type: string
                tags:
                  type: array
                  items:
                    type: string
                price:
                  type: number
                currency:
                  type: string
                coverImageUrl:
                  type: string
                videoUrl:
                  type: string
                status:
                  type: string
                  enum: [draft, published]
                stops:
                  type: array
                  items:
                    type: object
                    properties:
                      dayNumber:
                        type: integer
                      stopOrder:
                        type: integer
                      title:
                        type: string
                      description:
                        type: string
                      latitude:
                        type: number
                      longitude:
                        type: number
      responses:
        '200':
          description: Itinerary created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  itinerary:
                    $ref: '#/components/schemas/Itinerary'
        '400':
          description: Bad request
        '401':
          description: Unauthorized

  /functions/v1/getFeed:
    get:
      summary: Get personalized feed
      description: Retrieve itineraries based on user preferences and following
      operationId: getFeed
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: type
          in: query
          schema:
            type: string
            enum: [personalized, trending, following]
            default: personalized
      responses:
        '200':
          description: Feed retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  itineraries:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/Itinerary'
                        - type: object
                          properties:
                            is_liked:
                              type: boolean
                            is_saved:
                              type: boolean
                            is_purchased:
                              type: boolean
                  page:
                    type: integer
                  hasMore:
                    type: boolean
        '500':
          description: Server error

  /functions/v1/uploadSignedUrl:
    post:
      summary: Get signed upload URL
      description: Generate a signed URL for uploading media to Supabase Storage
      operationId: uploadSignedUrl
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - fileName
                - fileType
              properties:
                fileName:
                  type: string
                fileType:
                  type: string
                  enum:
                    - image/jpeg
                    - image/png
                    - image/gif
                    - image/webp
                    - video/mp4
                    - video/quicktime
                    - video/webm
                bucket:
                  type: string
                  default: media
                itineraryId:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Signed URL generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  uploadUrl:
                    type: string
                  token:
                    type: string
                  path:
                    type: string
                  publicUrl:
                    type: string
                  mediaId:
                    type: string
                    format: uuid
                  instructions:
                    type: object
                    properties:
                      method:
                        type: string
                      url:
                        type: string
                      headers:
                        type: object
        '400':
          description: Invalid file type
        '401':
          description: Unauthorized

  /rest/v1/itineraries:
    get:
      summary: List itineraries
      description: Query itineraries using PostgREST
      parameters:
        - name: select
          in: query
          schema:
            type: string
          description: Columns to select
        - name: status
          in: query
          schema:
            type: string
          description: Filter by status (e.g., eq.published)
        - name: order
          in: query
          schema:
            type: string
          description: Order results (e.g., published_at.desc)
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of itineraries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Itinerary'

  /rest/v1/profiles:
    get:
      summary: List profiles
      description: Query profiles using PostgREST
      responses:
        '200':
          description: List of profiles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Profile'

  /rest/v1/rpc/search_itineraries:
    post:
      summary: Search itineraries
      description: Full-text search using PostgreSQL
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                p_query:
                  type: string
                p_limit:
                  type: integer
                  default: 20
                p_offset:
                  type: integer
                  default: 0
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: array
                items:
                  allOf:
                    - $ref: '#/components/schemas/Itinerary'
                    - type: object
                      properties:
                        rank:
                          type: number
